<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>devito.operator.operator &mdash; Devito v4.6.2</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/devito_logo.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href="../../../_static/devito_style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Devito v4.6.2
              <img src="../../../_static/devito_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../download.html">Download</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/devitocodes/devito/tree/master/examples">Tutorials</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/devitocodes/devito/wiki/FAQ">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../userapi.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Devito v4.6.2</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">devito.operator.operator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for devito.operator.operator</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>

<span class="kn">from</span> <span class="nn">cached_property</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="kn">from</span> <span class="nn">devito.arch</span> <span class="kn">import</span> <span class="n">compiler_registry</span><span class="p">,</span> <span class="n">platform_registry</span>
<span class="kn">from</span> <span class="nn">devito.data</span> <span class="kn">import</span> <span class="n">default_allocator</span>
<span class="kn">from</span> <span class="nn">devito.exceptions</span> <span class="kn">import</span> <span class="n">InvalidOperator</span>
<span class="kn">from</span> <span class="nn">devito.logger</span> <span class="kn">import</span> <span class="n">debug</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">perf</span><span class="p">,</span> <span class="n">warning</span><span class="p">,</span> <span class="n">is_log_enabled_for</span>
<span class="kn">from</span> <span class="nn">devito.ir.equations</span> <span class="kn">import</span> <span class="n">LoweredEq</span><span class="p">,</span> <span class="n">lower_exprs</span>
<span class="kn">from</span> <span class="nn">devito.ir.clusters</span> <span class="kn">import</span> <span class="n">ClusterGroup</span><span class="p">,</span> <span class="n">clusterize</span>
<span class="kn">from</span> <span class="nn">devito.ir.iet</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Callable</span><span class="p">,</span> <span class="n">CInterface</span><span class="p">,</span> <span class="n">EntryFunction</span><span class="p">,</span> <span class="n">FindSymbols</span><span class="p">,</span> <span class="n">MetaCall</span><span class="p">,</span>
                           <span class="n">derive_parameters</span><span class="p">,</span> <span class="n">iet_build</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">devito.ir.support</span> <span class="kn">import</span> <span class="n">AccessMode</span><span class="p">,</span> <span class="n">SymbolRegistry</span>
<span class="kn">from</span> <span class="nn">devito.ir.stree</span> <span class="kn">import</span> <span class="n">stree_build</span>
<span class="kn">from</span> <span class="nn">devito.operator.profiling</span> <span class="kn">import</span> <span class="n">AdvancedProfilerVerbose</span><span class="p">,</span> <span class="n">create_profile</span>
<span class="kn">from</span> <span class="nn">devito.operator.registry</span> <span class="kn">import</span> <span class="n">operator_selector</span>
<span class="kn">from</span> <span class="nn">devito.mpi</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">devito.parameters</span> <span class="kn">import</span> <span class="n">configuration</span>
<span class="kn">from</span> <span class="nn">devito.passes</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Graph</span><span class="p">,</span> <span class="n">lower_index_derivatives</span><span class="p">,</span> <span class="n">generate_implicit</span><span class="p">,</span>
                           <span class="n">generate_macros</span><span class="p">,</span> <span class="n">minimize_symbols</span><span class="p">,</span> <span class="n">unevaluate</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">devito.symbolics</span> <span class="kn">import</span> <span class="n">estimate_cost</span>
<span class="kn">from</span> <span class="nn">devito.tools</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DAG</span><span class="p">,</span> <span class="n">OrderedSet</span><span class="p">,</span> <span class="n">Signer</span><span class="p">,</span> <span class="n">ReducerMap</span><span class="p">,</span> <span class="n">as_tuple</span><span class="p">,</span> <span class="n">flatten</span><span class="p">,</span>
                          <span class="n">filter_sorted</span><span class="p">,</span> <span class="n">frozendict</span><span class="p">,</span> <span class="n">is_integer</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">timed_pass</span><span class="p">,</span>
                          <span class="n">timed_region</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">devito.types</span> <span class="kn">import</span> <span class="n">Grid</span><span class="p">,</span> <span class="n">Evaluable</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Operator&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="Operator"><a class="viewcode-back" href="../../../operator.html#devito.operator.operator.Operator">[docs]</a><span class="k">class</span> <span class="nc">Operator</span><span class="p">(</span><span class="n">Callable</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate, JIT-compile and run C code starting from an ordered sequence</span>
<span class="sd">    of symbolic expressions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    expressions : expr-like or list or expr-like</span>
<span class="sd">        The (list of) expression(s) defining the Operator computation.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        * name : str</span>
<span class="sd">            Name of the Operator, defaults to &quot;Kernel&quot;.</span>
<span class="sd">        * subs : dict</span>
<span class="sd">            Symbolic substitutions to be applied to ``expressions``.</span>
<span class="sd">        * opt : str</span>
<span class="sd">            The performance optimization level. Defaults to ``configuration[&#39;opt&#39;]``.</span>
<span class="sd">        * language : str</span>
<span class="sd">            The target language for shared-memory parallelism. Defaults to</span>
<span class="sd">            ``configuration[&#39;language&#39;]``.</span>
<span class="sd">        * platform : str</span>
<span class="sd">            The architecture the code is generated for. Defaults to</span>
<span class="sd">            ``configuration[&#39;platform&#39;]``.</span>
<span class="sd">        * compiler : str</span>
<span class="sd">            The backend compiler used to jit-compile the generated code.</span>
<span class="sd">            Defaults to ``configuration[&#39;compiler&#39;]``.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    The following Operator implements a trivial time-marching method that</span>
<span class="sd">    adds 1 to every grid point in ``u`` at every timestep.</span>

<span class="sd">    &gt;&gt;&gt; from devito import Eq, Grid, TimeFunction, Operator</span>
<span class="sd">    &gt;&gt;&gt; grid = Grid(shape=(4, 4))</span>
<span class="sd">    &gt;&gt;&gt; u = TimeFunction(name=&#39;u&#39;, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; op = Operator(Eq(u.forward, u + 1))</span>

<span class="sd">    Multiple expressions can be supplied, and there is no limit to the number of</span>
<span class="sd">    expressions in an Operator.</span>

<span class="sd">    &gt;&gt;&gt; v = TimeFunction(name=&#39;v&#39;, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; op = Operator([Eq(u.forward, u + 1),</span>
<span class="sd">    ...                Eq(v.forward, v + 1)])</span>

<span class="sd">    Simple boundary conditions can be imposed easily exploiting the &quot;indexed</span>
<span class="sd">    notation&quot; for Functions/TimeFunctions.</span>

<span class="sd">    &gt;&gt;&gt; t = grid.stepping_dim</span>
<span class="sd">    &gt;&gt;&gt; x, y = grid.dimensions</span>
<span class="sd">    &gt;&gt;&gt; op = Operator([Eq(u.forward, u + 1),</span>
<span class="sd">    ...                Eq(u[t+1, x, 0], 0),</span>
<span class="sd">    ...                Eq(u[t+1, x, 2], 0),</span>
<span class="sd">    ...                Eq(u[t+1, 0, y], 0),</span>
<span class="sd">    ...                Eq(u[t+1, 2, y], 0)])</span>

<span class="sd">    A semantically equivalent computation can be expressed exploiting SubDomains.</span>

<span class="sd">    &gt;&gt;&gt; u.data[:] = 0</span>
<span class="sd">    &gt;&gt;&gt; op = Operator(Eq(u.forward, u + 1, subdomain=grid.interior))</span>

<span class="sd">    By specifying a SubDomain, the Operator constrains the execution of an expression to</span>
<span class="sd">    a certain sub-region within the computational domain. Ad-hoc SubDomains can also be</span>
<span class="sd">    created in application code -- refer to the SubDomain documentation for more info.</span>

<span class="sd">    Advanced boundary conditions can be expressed leveraging `SubDomain` and</span>
<span class="sd">    `SubDimension`.</span>

<span class="sd">    Tensor contractions are supported, but with one caveat: in case of MPI execution, any</span>
<span class="sd">    global reductions along an MPI-distributed Dimension should be handled explicitly in</span>
<span class="sd">    user code. The following example shows how to implement the matrix-vector</span>
<span class="sd">    multiplication ``Av = b`` (inducing a reduction along ``y``).</span>

<span class="sd">    &gt;&gt;&gt; from devito import Inc, Function</span>
<span class="sd">    &gt;&gt;&gt; A = Function(name=&#39;A&#39;, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; v = Function(name=&#39;v&#39;, shape=(3,), dimensions=(y,))</span>
<span class="sd">    &gt;&gt;&gt; b = Function(name=&#39;b&#39;, shape=(3,), dimensions=(x,))</span>
<span class="sd">    &gt;&gt;&gt; op = Operator(Inc(b, A*v))</span>

<span class="sd">    Dense and sparse computation may be present within the same Operator. In the</span>
<span class="sd">    following example, interpolation is used to approximate the value of four</span>
<span class="sd">    sparse points placed at the center of the four quadrants at the grid corners.</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from devito import SparseFunction</span>
<span class="sd">    &gt;&gt;&gt; grid = Grid(shape=(4, 4), extent=(3.0, 3.0))</span>
<span class="sd">    &gt;&gt;&gt; f = Function(name=&#39;f&#39;, grid=grid)</span>
<span class="sd">    &gt;&gt;&gt; coordinates = np.array([(0.5, 0.5), (0.5, 2.5), (2.5, 0.5), (2.5, 2.5)])</span>
<span class="sd">    &gt;&gt;&gt; sf = SparseFunction(name=&#39;sf&#39;, grid=grid, npoint=4, coordinates=coordinates)</span>
<span class="sd">    &gt;&gt;&gt; op = Operator([Eq(f, f + 1)] + sf.interpolate(f))</span>

<span class="sd">    The iteration direction is automatically detected by the Devito compiler. Below,</span>
<span class="sd">    the Operator runs from ``time_M`` (maximum point in the time dimension) down to</span>
<span class="sd">    ``time_m`` (minimum point in the time dimension), as opposed to all of the examples</span>
<span class="sd">    seen so far, in which the execution along time proceeds from ``time_m`` to ``time_M``</span>
<span class="sd">    through unit-step increments.</span>

<span class="sd">    &gt;&gt;&gt; op = Operator(Eq(u.backward, u + 1))</span>

<span class="sd">    Loop-level optimisations, including SIMD vectorisation and OpenMP parallelism, are</span>
<span class="sd">    automatically discovered and handled by the Devito compiler. For more information,</span>
<span class="sd">    refer to the relevant documentation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_default_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_POSIX_C_SOURCE&#39;</span><span class="p">,</span> <span class="s1">&#39;200809L&#39;</span><span class="p">)]</span>
    <span class="n">_default_includes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stdlib.h&#39;</span><span class="p">,</span> <span class="s1">&#39;math.h&#39;</span><span class="p">,</span> <span class="s1">&#39;sys/time.h&#39;</span><span class="p">]</span>
    <span class="n">_default_globals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">expressions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Return a dummy Callable. This is exploited by unpickling. Users</span>
            <span class="c1"># can&#39;t do anything useful with it</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Operator</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Parse input arguments</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># The Operator type for the given target</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">operator_selector</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Normalize input arguments for the selected Operator</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_normalize_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_check_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Lower to a JIT-compilable object</span>
        <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;op-compile&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">op</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_build</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">py_timers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">timings</span><span class="p">)</span>

        <span class="c1"># Emit info about how long it took to perform the lowering</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_emit_build_profiling</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">op</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_normalize_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">kwargs</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_kwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Python- (i.e., compile-) and C-level (i.e., run-time) performance</span>
        <span class="n">profiler</span> <span class="o">=</span> <span class="n">create_profile</span><span class="p">(</span><span class="s1">&#39;timers&#39;</span><span class="p">)</span>

        <span class="c1"># Lower the input expressions into an IET</span>
        <span class="n">irs</span><span class="p">,</span> <span class="n">byproduct</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Make it an actual Operator</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">Callable</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">irs</span><span class="o">.</span><span class="n">iet</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">Callable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="o">**</span><span class="n">op</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Header files, etc.</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_headers</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_default_headers</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byproduct</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_globals</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_default_globals</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byproduct</span><span class="o">.</span><span class="n">globals</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_includes</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_default_includes</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_includes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profiler</span><span class="o">.</span><span class="n">_default_includes</span><span class="p">)</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_includes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">byproduct</span><span class="o">.</span><span class="n">includes</span><span class="p">)</span>

        <span class="c1"># Required for the jit-compilation</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_compiler</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_language</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_lib</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_cfunction</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Potentially required for lazily allocated Functions</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_options</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_allocator</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allocator&#39;</span><span class="p">]</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_platform</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span>

        <span class="c1"># References to local or external routines</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_func_table</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_func_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="n">MetaCall</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
                                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">profiler</span><span class="o">.</span><span class="n">_ext_calls</span><span class="p">]))</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_func_table</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">i</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">byproduct</span><span class="o">.</span><span class="n">funcs</span><span class="p">]))</span>

        <span class="c1"># Internal mutable state to store information about previous runs, autotuning</span>
        <span class="c1"># reports, etc</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_initialize_state</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Produced by the various compilation passes</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_reads</span> <span class="o">=</span> <span class="n">filter_sorted</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">reads</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">irs</span><span class="o">.</span><span class="n">expressions</span><span class="p">))</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_writes</span> <span class="o">=</span> <span class="n">filter_sorted</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">writes</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">irs</span><span class="o">.</span><span class="n">expressions</span><span class="p">))</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_dimensions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">dimensions</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">irs</span><span class="o">.</span><span class="n">expressions</span><span class="p">])</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">_dspace</span> <span class="o">=</span> <span class="n">irs</span><span class="o">.</span><span class="n">clusters</span><span class="o">.</span><span class="n">meta</span>
        <span class="n">op</span><span class="o">.</span><span class="n">_profiler</span> <span class="o">=</span> <span class="n">profiler</span>

        <span class="k">return</span> <span class="n">op</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Bypass the silent call to __init__ triggered through the backends engine</span>
        <span class="k">pass</span>

    <span class="c1"># Compilation -- Expression level</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_lower</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the lowering Expressions -&gt; Clusters -&gt; ScheduleTree -&gt; IET.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a symbol registry</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sregistry&#39;</span><span class="p">,</span> <span class="n">SymbolRegistry</span><span class="p">())</span>

        <span class="n">expressions</span> <span class="o">=</span> <span class="n">as_tuple</span><span class="p">(</span><span class="n">expressions</span><span class="p">)</span>

        <span class="c1"># Input check</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Evaluable</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidOperator</span><span class="p">(</span><span class="s2">&quot;Only `devito.Evaluable` are allowed.&quot;</span><span class="p">)</span>

        <span class="c1"># Enable recursive lowering</span>
        <span class="c1"># This may be used by a compilation pass that constructs a new</span>
        <span class="c1"># expression for which a partial or complete lowering is desired</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rcompile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rcompile_wrapper</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># [Eq] -&gt; [LoweredEq]</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower_exprs</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># [LoweredEq] -&gt; [Clusters]</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower_clusters</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># [Clusters] -&gt; ScheduleTree</span>
        <span class="n">stree</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower_stree</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># ScheduleTree -&gt; unbounded IET</span>
        <span class="n">uiet</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower_uiet</span><span class="p">(</span><span class="n">stree</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># unbounded IET -&gt; IET</span>
        <span class="n">iet</span><span class="p">,</span> <span class="n">byproduct</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower_iet</span><span class="p">(</span><span class="n">uiet</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">IRs</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">stree</span><span class="p">,</span> <span class="n">uiet</span><span class="p">,</span> <span class="n">iet</span><span class="p">),</span> <span class="n">byproduct</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_rcompile_wrapper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rcompile</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_initialize_state</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize_dsl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backend hook for specialization at the DSL level. The input is made of</span>
<span class="sd">        expressions and other higher order objects such as Injection or</span>
<span class="sd">        Interpolation; the expressions are still unevaluated at this stage,</span>
<span class="sd">        meaning that they are still in tensorial form and derivatives aren&#39;t</span>
<span class="sd">        expanded yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">expressions</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize_exprs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backend hook for specialization at the expression level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">expressions</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@timed_pass</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lowering.Expressions&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_lower_exprs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Expression lowering:</span>

<span class="sd">            * Apply rewrite rules;</span>
<span class="sd">            * Evaluate derivatives;</span>
<span class="sd">            * Flatten vectorial equations;</span>
<span class="sd">            * Indexify Functions;</span>
<span class="sd">            * Apply substitution rules;</span>
<span class="sd">            * Shift indices for domain alignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expand</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Specialization is performed on unevaluated expressions</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize_dsl</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Lower functional DSL</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="n">flatten</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">_evaluate</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="n">expand</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">])</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">_flatten</span><span class="p">]</span>

        <span class="c1"># A second round of specialization is performed on evaluated expressions</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize_exprs</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># &quot;True&quot; lowering (indexification, shifting, ...)</span>
        <span class="n">expressions</span> <span class="o">=</span> <span class="n">lower_exprs</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">processed</span> <span class="o">=</span> <span class="p">[</span><span class="n">LoweredEq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">processed</span>

    <span class="c1"># Compilation -- Cluster level</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize_clusters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backend hook for specialization at the Cluster level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">clusters</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@timed_pass</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lowering.Clusters&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_lower_clusters</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">profiler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clusters lowering:</span>

<span class="sd">            * Group expressions into Clusters;</span>
<span class="sd">            * Introduce guards for conditional Clusters;</span>
<span class="sd">            * Analyze Clusters to detect computational properties such</span>
<span class="sd">              as parallelism.</span>
<span class="sd">            * Optimize Clusters for performance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sregistry</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sregistry&#39;</span><span class="p">]</span>

        <span class="c1"># Build a sequence of Clusters from a sequence of Eqs</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">clusterize</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Operation count before specialization</span>
        <span class="n">init_ops</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">estimate_cost</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_dense</span><span class="p">)</span>

        <span class="n">clusters</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize_clusters</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Operation count after specialization</span>
        <span class="n">final_ops</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">estimate_cost</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">exprs</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clusters</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_dense</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">profiler</span><span class="o">.</span><span class="n">record_ops_variation</span><span class="p">(</span><span class="n">init_ops</span><span class="p">,</span> <span class="n">final_ops</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Generate implicit Clusters from higher level abstractions</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">generate_implicit</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">sregistry</span><span class="o">=</span><span class="n">sregistry</span><span class="p">)</span>

        <span class="c1"># Lower all remaining high order symbolic objects</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">lower_index_derivatives</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Make sure no reconstructions can unpick any of the symbolic</span>
        <span class="c1"># optimizations performed so far</span>
        <span class="n">clusters</span> <span class="o">=</span> <span class="n">unevaluate</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ClusterGroup</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>

    <span class="c1"># Compilation -- ScheduleTree level</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize_stree</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">stree</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backend hook for specialization at the Schedule tree level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">stree</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@timed_pass</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lowering.ScheduleTree&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_lower_stree</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule tree lowering:</span>

<span class="sd">            * Turn a sequence of Clusters into a ScheduleTree;</span>
<span class="sd">            * Derive and attach metadata for distributed-memory parallelism;</span>
<span class="sd">            * Derive sections for performance profiling</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build a ScheduleTree from a sequence of Clusters</span>
        <span class="n">stree</span> <span class="o">=</span> <span class="n">stree_build</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">stree</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize_stree</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stree</span>

    <span class="c1"># Compilation -- Iteration/Expression tree level</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_specialize_iet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backend hook for specialization at the Iteration/Expression tree level.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">graph</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@timed_pass</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lowering.uIET&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_lower_uiet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">stree</span><span class="p">,</span> <span class="n">profiler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn a ScheduleTree into an unbounded Iteration/Expression tree, that is</span>
<span class="sd">        in essence a &quot;floating&quot; IET where one or more variables may be unbounded</span>
<span class="sd">        (i.e., no definition placed yet).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build an unbounded IET from a ScheduleTree</span>
        <span class="n">uiet</span> <span class="o">=</span> <span class="n">iet_build</span><span class="p">(</span><span class="n">stree</span><span class="p">)</span>

        <span class="c1"># Analyze the IET Sections for C-level profiling</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">profiler</span><span class="o">.</span><span class="n">analyze</span><span class="p">(</span><span class="n">uiet</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">uiet</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@timed_pass</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;lowering.IET&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_lower_iet</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">uiet</span><span class="p">,</span> <span class="n">profiler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iteration/Expression tree lowering:</span>

<span class="sd">            * Introduce distributed-memory, shared-memory, and SIMD parallelism;</span>
<span class="sd">            * Introduce optimizations for data locality;</span>
<span class="sd">            * Finalize (e.g., symbol definitions, array casts)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Kernel&quot;</span><span class="p">)</span>
        <span class="n">sregistry</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sregistry&#39;</span><span class="p">]</span>

        <span class="c1"># Wrap the IET with an EntryFunction (a special Callable representing</span>
        <span class="c1"># the entry point of the generated library)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">derive_parameters</span><span class="p">(</span><span class="n">uiet</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">iet</span> <span class="o">=</span> <span class="n">EntryFunction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">uiet</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="p">())</span>

        <span class="c1"># Lower IET to a target-specific IET</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">iet</span><span class="p">,</span> <span class="n">sregistry</span><span class="o">=</span><span class="n">sregistry</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_specialize_iet</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Instrument the IET for C-level profiling</span>
        <span class="c1"># Note: this is postponed until after _specialize_iet because during</span>
        <span class="c1"># specialization further Sections may be introduced</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_Target</span><span class="o">.</span><span class="n">instrument</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">profiler</span><span class="o">=</span><span class="n">profiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Extract the necessary macros from the symbolic objects</span>
        <span class="n">generate_macros</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

        <span class="c1"># Target-independent optimizations</span>
        <span class="n">minimize_symbols</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">graph</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">graph</span>

    <span class="c1"># Read-only properties exposed to the outside world</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">reads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reads</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">writes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_writes</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">_defines</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dimensions</span><span class="p">])</span>

        <span class="c1"># During compilation other Dimensions may have been produced</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="n">FindSymbols</span><span class="p">(</span><span class="s1">&#39;dimensions&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dimensions</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_PerfKnob</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Input</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">temporaries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_TempFunction</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">objects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Object</span><span class="p">)</span>

    <span class="c1"># Arguments processing</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_access_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A table providing the AccessMode of all user-accessible symbols in `self`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">frozendict</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="n">AccessMode</span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reads</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">writes</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_prepare_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">autotune</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process runtime arguments passed to ``.apply()` and derive</span>
<span class="sd">        default values for any remaining arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sanity check -- all user-provided keywords must be known to the Operator</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;ignore-unknowns&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_known_arguments</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unrecognized argument </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="c1"># Pre-process Dimension overrides. This may help ruling out ambiguities</span>
        <span class="c1"># when processing the `defaults` arguments. A topological sorting is used</span>
        <span class="c1"># as DerivedDimensions may depend on their parents</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span>
                 <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_Derived</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">parent</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">)]</span>
        <span class="n">toposort</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">()</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">toposort</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">_arg_names</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">_arg_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dspace</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="n">overrides</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Process data-carrier overrides</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReducerMap</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">overrides</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_arg_values</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">reduce_inplace</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Override `</span><span class="si">%s</span><span class="s2">` is incompatible with overrides `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">overrides</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]))</span>

        <span class="c1"># Process data-carrier defaults</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="c1"># E.g., SubFunctions</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">_arg_values</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                    <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
                    <span class="c1"># An explicit override is later going to set `args[k]`</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="c1"># User is in control</span>
                    <span class="c1"># E.g., given a ConditionalDimension `t_sub` with factor `fact` and</span>
                    <span class="c1"># a TimeFunction `usave(t_sub, x, y)`, an override for `fact` is</span>
                    <span class="c1"># supplied w/o overriding `usave`; that&#39;s legal</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">is_integer</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">as_tuple</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Default `</span><span class="si">%s</span><span class="s2">` is incompatible with other args as &quot;</span>
                                     <span class="s2">&quot;`</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">`, while `</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">` is expected. Perhaps you &quot;</span>
                                     <span class="s2">&quot;forgot to override `</span><span class="si">%s</span><span class="s2">`?&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">p</span><span class="p">))</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">reduce_all</span><span class="p">()</span>

        <span class="c1"># DiscreteFunctions may be created from CartesianDiscretizations, which in</span>
        <span class="c1"># turn could be Grids or SubDomains. Both may provide arguments</span>
        <span class="n">discretizations</span> <span class="o">=</span> <span class="p">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">overrides</span><span class="p">}</span>
        <span class="n">discretizations</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s1">&#39;grid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">})</span>
        <span class="n">discretizations</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">discretizations</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">_arg_values</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="c1"># There can only be one Grid from which DiscreteFunctions were created</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">discretizations</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Grid</span><span class="p">)}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">grids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># We loosely tolerate multiple Grids for backwards compatibility</span>
            <span class="c1"># with spacial subsampling, which should be revisited however. And</span>
            <span class="c1"># With MPI it would definitely break!</span>
            <span class="k">if</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Multiple Grids found&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># An ArgumentsMap carries additional metadata that may be used by</span>
        <span class="c1"># the subsequent phases of the arguments processing</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ArgumentsMap</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Process Dimensions</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">toposort</span><span class="p">):</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">_arg_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dspace</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="c1"># Process Objects</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">objects</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">_arg_values</span><span class="p">(</span><span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="c1"># In some &quot;lower-level&quot; Operators implementing a random piece of C, such as</span>
        <span class="c1"># one or more calls to third-party library functions, there could still be</span>
        <span class="c1"># at this point unprocessed arguments (e.g., scalars)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">})</span>

        <span class="c1"># Sanity check</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_arg_check</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dspace</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="n">am</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_access_modes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">is_Derived</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">_arg_check</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dspace</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>

        <span class="c1"># Turn arguments into a format suitable for the generated code</span>
        <span class="c1"># E.g., instead of NumPy arrays for Functions, the generated code expects</span>
        <span class="c1"># pointers to ctypes.Struct</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">_arg_finalize</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># User-provided floats/ndarray obviously do not have `_arg_finalize`</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_arg_finalize</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">alias</span><span class="o">=</span><span class="n">p</span><span class="p">))</span>

        <span class="c1"># Execute autotuning and adjust arguments accordingly</span>
        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_autotune</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">autotune</span> <span class="ow">or</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;autotuning&#39;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_postprocess_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process runtime arguments upon returning from ``.apply()``.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">_arg_apply</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">_arg_apply</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_known_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The arguments that can be passed to ``apply`` when running the Operator.&quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">_arg_names</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">_arg_names</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">_arg_names</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_autotune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">setup</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-tuning to improve runtime performance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">args</span>

<div class="viewcode-block" id="Operator.arguments"><a class="viewcode-back" href="../../../operator.html#devito.operator.operator.Operator.arguments">[docs]</a>    <span class="k">def</span> <span class="nf">arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Arguments to run the Operator.&quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_arguments</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Check all arguments are present</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No value found for parameter </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span></div>

    <span class="c1"># Code generation and JIT compilation</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_soname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A unique name for the shared object resulting from JIT compilation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Signer</span><span class="o">.</span><span class="n">_digest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">ccode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ccode_handler</span><span class="p">(</span><span class="n">compiler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">devito.ir.iet.visitors</span> <span class="kn">import</span> <span class="n">CGen</span>
            <span class="k">return</span> <span class="n">CGen</span><span class="p">(</span><span class="n">compiler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="p">)</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_jit_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        JIT-compile the C code generated by the Operator.</span>

<span class="sd">        It is ensured that JIT compilation will only be performed once per</span>
<span class="sd">        Operator, reagardless of how many times this method is invoked.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">timer_on</span><span class="p">(</span><span class="s1">&#39;jit-compile&#39;</span><span class="p">):</span>
                <span class="n">recompiled</span><span class="p">,</span> <span class="n">src_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">jit_compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_soname</span><span class="p">,</span>
                                                                  <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ccode</span><span class="p">))</span>

            <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">py_timers</span><span class="p">[</span><span class="s1">&#39;jit-compile&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">recompiled</span><span class="p">:</span>
                <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Operator `</span><span class="si">%s</span><span class="s2">` jit-compiled `</span><span class="si">%s</span><span class="s2">` in </span><span class="si">%.2f</span><span class="s2"> s with `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Operator `</span><span class="si">%s</span><span class="s2">` fetched `</span><span class="si">%s</span><span class="s2">` in </span><span class="si">%.2f</span><span class="s2"> s from jit-cache&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">src_file</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cfunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The JIT-compiled C function as a ctypes.FuncPtr object.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_jit_compile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_soname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_soname</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfunction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cfunction</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># Associate a C type to each argument for runtime type check</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cfunction</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">_C_ctype</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfunction</span>

<div class="viewcode-block" id="Operator.cinterface"><a class="viewcode-back" href="../../../operator.html#devito.operator.operator.Operator.cinterface">[docs]</a>    <span class="k">def</span> <span class="nf">cinterface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate two files under the prescribed temporary directory:</span>

<span class="sd">            * `X.c` (or `X.cpp`): the code generated for this Operator;</span>
<span class="sd">            * `X.h`: an header file representing the interface of `X.c`.</span>

<span class="sd">        Where `X=self.name`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        force : bool, optional</span>
<span class="sd">            Overwrite any existing files. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">get_jit_dir</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dest</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">cfile</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">src_ext</span><span class="p">)</span>
        <span class="n">hfile</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.h&#39;</span><span class="p">)</span>

        <span class="c1"># Generate the .c and .h code</span>
        <span class="n">ccode</span><span class="p">,</span> <span class="n">hcode</span> <span class="o">=</span> <span class="n">CInterface</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">cfile</span><span class="p">,</span> <span class="n">ccode</span><span class="p">),</span> <span class="p">(</span><span class="n">hfile</span><span class="p">,</span> <span class="n">hcode</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">debug</span><span class="p">(</span><span class="s2">&quot;`</span><span class="si">%s</span><span class="s2">` was not saved in `</span><span class="si">%s</span><span class="s2">` as it already exists&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
                    <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
                <span class="n">debug</span><span class="p">(</span><span class="s2">&quot;`</span><span class="si">%s</span><span class="s2">` successfully saved in `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ccode</span><span class="p">,</span> <span class="n">hcode</span></div>

    <span class="c1"># Execution</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Operator.apply"><a class="viewcode-back" href="../../../operator.html#devito.operator.operator.Operator.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the Operator.</span>

<span class="sd">        With no arguments provided, the Operator runs using the data carried by the</span>
<span class="sd">        objects appearing in the input expressions -- these are referred to as the</span>
<span class="sd">        &quot;default arguments&quot;.</span>

<span class="sd">        Optionally, any of the Operator default arguments may be replaced by passing</span>
<span class="sd">        suitable key-value arguments. Given ``apply(k=v, ...)``, ``(k, v)`` may be</span>
<span class="sd">        used to:</span>

<span class="sd">        * replace a Constant. In this case, ``k`` is the name of the Constant,</span>
<span class="sd">          ``v`` is either a Constant or a scalar value.</span>

<span class="sd">        * replace a Function (SparseFunction). Here, ``k`` is the name of the</span>
<span class="sd">          Function, ``v`` is either a Function or a numpy.ndarray.</span>

<span class="sd">        * alter the iteration interval along a Dimension. Consider a generic</span>
<span class="sd">          Dimension ``d`` iterated over by the Operator.  By default, the Operator</span>
<span class="sd">          runs over all iterations within the compact interval ``[d_m, d_M]``,</span>
<span class="sd">          where ``d_m`` and ``d_M`` are, respectively, the smallest and largest</span>
<span class="sd">          integers not causing out-of-bounds memory accesses (for the Grid</span>
<span class="sd">          Dimensions, this typically implies iterating over the entire physical</span>
<span class="sd">          domain). So now ``k`` can be either ``d_m`` or ``d_M``, while ``v``</span>
<span class="sd">          is an integer value.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Consider the following Operator</span>

<span class="sd">        &gt;&gt;&gt; from devito import Eq, Grid, TimeFunction, Operator</span>
<span class="sd">        &gt;&gt;&gt; grid = Grid(shape=(3, 3))</span>
<span class="sd">        &gt;&gt;&gt; u = TimeFunction(name=&#39;u&#39;, grid=grid, save=3)</span>
<span class="sd">        &gt;&gt;&gt; op = Operator(Eq(u.forward, u + 1))</span>

<span class="sd">        The Operator is run by calling ``apply``</span>

<span class="sd">        &gt;&gt;&gt; summary = op.apply()</span>

<span class="sd">        The variable ``summary`` contains information about runtime performance.</span>
<span class="sd">        As no key-value parameters are specified, the Operator runs with its</span>
<span class="sd">        default arguments, namely ``u=u, x_m=0, x_M=2, y_m=0, y_M=2, time_m=0,</span>
<span class="sd">        time_M=1``.</span>

<span class="sd">        At this point, the same Operator can be used for a completely different</span>
<span class="sd">        run, for example</span>

<span class="sd">        &gt;&gt;&gt; u2 = TimeFunction(name=&#39;u&#39;, grid=grid, save=5)</span>
<span class="sd">        &gt;&gt;&gt; summary = op.apply(u=u2, x_m=1, y_M=1)</span>

<span class="sd">        Now, the Operator will run with a different set of arguments, namely</span>
<span class="sd">        ``u=u2, x_m=1, x_M=2, y_m=0, y_M=1, time_m=0, time_M=3``.</span>

<span class="sd">        To run an Operator that only uses buffered TimeFunctions, the maximum</span>
<span class="sd">        iteration point along the time dimension must be explicitly specified</span>
<span class="sd">        (otherwise, the Operator wouldn&#39;t know how many iterations to run).</span>

<span class="sd">        &gt;&gt;&gt; u3 = TimeFunction(name=&#39;u&#39;, grid=grid)</span>
<span class="sd">        &gt;&gt;&gt; op = Operator(Eq(u3.forward, u3 + 1))</span>
<span class="sd">        &gt;&gt;&gt; summary = op.apply(time_M=10)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build the arguments list to invoke the kernel function</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">timer_on</span><span class="p">(</span><span class="s1">&#39;arguments&#39;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Invoke kernel function with args</span>
        <span class="n">arg_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cfunction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfunction</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">timer_on</span><span class="p">(</span><span class="s1">&#39;apply&#39;</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">comm</span><span class="p">):</span>
                <span class="n">cfunction</span><span class="p">(</span><span class="o">*</span><span class="n">arg_values</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">ArgumentError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;argument &quot;</span><span class="p">):</span>
                <span class="n">argnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">9</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">newmsg</span> <span class="o">=</span> <span class="s2">&quot;error in argument &#39;</span><span class="si">%s</span><span class="s2">&#39; with value &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">argnum</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">arg_values</span><span class="p">[</span><span class="n">argnum</span><span class="p">],</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">newmsg</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c1"># Post-process runtime arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_arguments</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Output summary of performance achieved</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emit_apply_profiling</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>

    <span class="c1"># Performance profiling</span>

    <span class="k">def</span> <span class="nf">_emit_build_profiling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_log_enabled_for</span><span class="p">(</span><span class="s1">&#39;PERF&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># Rounder to K decimal places</span>
        <span class="n">fround</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">100</span><span class="p">:</span> <span class="n">ceil</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span>

        <span class="n">timings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">py_timers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">tot</span> <span class="o">=</span> <span class="n">timings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;op-compile&#39;</span><span class="p">)</span>
        <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Operator `</span><span class="si">%s</span><span class="s2">` generated in </span><span class="si">%.2f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fround</span><span class="p">(</span><span class="n">tot</span><span class="p">)))</span>

        <span class="n">max_hotspots</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mf">20.</span>

        <span class="k">def</span> <span class="nf">_emit_timings</span><span class="p">(</span><span class="n">timings</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">timings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">timings</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">timings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">[:</span><span class="n">max_hotspots</span><span class="p">]:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">fround</span><span class="p">(</span><span class="n">timings</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>
                <span class="n">perc</span> <span class="o">=</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">/</span><span class="n">tot</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">perc</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">: </span><span class="si">%.2f</span><span class="s2"> s (</span><span class="si">%.1f</span><span class="s2"> </span><span class="si">%%</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="n">v</span><span class="p">,</span> <span class="n">perc</span><span class="p">))</span>
                    <span class="n">_emit_timings</span><span class="p">(</span><span class="n">timings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">indent</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span><span class="p">)</span>

        <span class="n">_emit_timings</span><span class="p">(</span><span class="n">timings</span><span class="p">,</span> <span class="s1">&#39;  * &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">_ops</span><span class="p">:</span>
            <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> --&gt; </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">_ops</span><span class="p">]</span>
            <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Flops reduction after symbolic optimization: [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s1">&#39; ; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ops</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_emit_apply_profiling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a performance summary of the profiled sections.&quot;&quot;&quot;</span>
        <span class="c1"># Rounder to 2 decimal places</span>
        <span class="n">fround</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">ceil</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="n">fround</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">py_timers</span><span class="p">[</span><span class="s1">&#39;apply&#39;</span><span class="p">])</span>
        <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Operator `</span><span class="si">%s</span><span class="s2">` ran in </span><span class="si">%.2f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">))</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="n">reduce_over</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_log_enabled_for</span><span class="p">(</span><span class="s1">&#39;PERF&#39;</span><span class="p">):</span>
            <span class="c1"># Do not waste time</span>
            <span class="k">return</span> <span class="n">summary</span>

        <span class="k">if</span> <span class="n">summary</span><span class="o">.</span><span class="n">globals</span><span class="p">:</span>
            <span class="c1"># Note that with MPI enabled, the global performance indicators</span>
            <span class="c1"># represent &quot;cross-rank&quot; performance data</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">v</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vanilla&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;OI=</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">oi</span><span class="p">))</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> GFlops/s&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">gflopss</span><span class="p">))</span>

            <span class="n">v</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fdlike&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> GPts/s&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">gpointss</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Global performance: [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>

            <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Local performance:&quot;</span><span class="p">)</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profiler</span><span class="p">,</span> <span class="n">AdvancedProfilerVerbose</span><span class="p">):</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">v</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fdlike-nosetup&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">metrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> GPts/s&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">gpointss</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                    <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Global performance &lt;w/o setup&gt;: [</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>

        <span class="c1"># Emit local, i.e. &quot;per-rank&quot; performance. Without MPI, this is the only</span>
        <span class="c1"># thing that will be emitted</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">rank</span> <span class="o">=</span> <span class="s2">&quot;[rank</span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="o">.</span><span class="n">rank</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">rank</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">gflopss</span><span class="p">:</span>
                <span class="n">oi</span> <span class="o">=</span> <span class="s2">&quot;OI=</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">oi</span><span class="p">)</span>
                <span class="n">gflopss</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> GFlops/s&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">gflopss</span><span class="p">)</span>
                <span class="n">gpointss</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2"> GPts/s&quot;</span> <span class="o">%</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">gpointss</span><span class="p">)</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">oi</span><span class="p">,</span> <span class="n">gflopss</span><span class="p">,</span> <span class="n">gpointss</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metrics</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">itershapes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">its</span><span class="p">)</span> <span class="k">for</span> <span class="n">its</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">itershapes</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itershapes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">itershapes</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itershapes</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">itershapes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">itershapes</span> <span class="o">=</span> <span class="n">itershapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">itershapes</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">itershapes</span><span class="p">)</span>

            <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">* </span><span class="si">%s</span><span class="s2"> ran in </span><span class="si">%.2f</span><span class="s2"> s </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fround</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">metrics</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">summary</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">+ </span><span class="si">%s</span><span class="s2"> ran in </span><span class="si">%.2f</span><span class="s2"> s [</span><span class="si">%.2f%%</span><span class="s2">]&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">indent</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">fround</span><span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="n">v</span><span class="o">.</span><span class="n">time</span><span class="o">*</span><span class="mi">100</span><span class="p">)))</span>

        <span class="c1"># Emit performance mode and arguments</span>
        <span class="n">perf_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dimensions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">is_PerfKnob</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">perf_args</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># Try with the aliases</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">_arg_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                        <span class="n">perf_args</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                        <span class="k">break</span>
        <span class="n">perf</span><span class="p">(</span><span class="s2">&quot;Performance[mode=</span><span class="si">%s</span><span class="s2">] arguments: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">perf_args</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">summary</span>

    <span class="c1"># Pickling support</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="c1"># The compiled shared-object will be pickled; upon unpickling, it</span>
            <span class="c1"># will be restored into a potentially different temporary directory,</span>
            <span class="c1"># so the entire process during which the shared-object is loaded and</span>
            <span class="c1"># given to ctypes must be performed again</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;_lib&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;_cfunction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Do not pickle the `args` used to construct the Operator. Not only</span>
            <span class="c1"># would this be completely useless, but it might also lead to</span>
            <span class="c1"># allocating additional memory upon unpickling, as the user-provided</span>
            <span class="c1"># equations typically carry different instances of the same Function</span>
            <span class="c1"># (e.g., f(t, x-1), f(t, x), f(t, x+1)), which are different objects</span>
            <span class="c1"># with distinct `.data` fields</span>
            <span class="n">state</span><span class="p">[</span><span class="s1">&#39;_args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;binary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">state</span><span class="p">[</span><span class="s1">&#39;soname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_soname</span>
            <span class="k">return</span> <span class="n">state</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">def</span> <span class="nf">__getnewargs_ex__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">soname</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;soname&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">binary</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;binary&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">soname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">soname</span><span class="p">,</span> <span class="n">binary</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compiler</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">soname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lib</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">soname</span></div>


<span class="c1"># Default action (perform or bypass) for selected compilation passes upon</span>
<span class="c1"># recursive compilation</span>
<span class="c1"># NOTE: it may not only be pointless to apply the following passes recursively</span>
<span class="c1"># (because once, during the main compilation phase, is simply enough), but also</span>
<span class="c1"># dangerous as some of them (the minority) might break in some circumstances</span>
<span class="c1"># if applied in cascade (e.g., `linearization` on top of `linearization`)</span>
<span class="n">rcompile_registry</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mpi&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;linearize&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;place-transfers&#39;</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">rcompile</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform recursive compilation on an ordered sequence of symbolic expressions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s1">&#39;options&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">parse_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">operator_selector</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_normalize_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">operator_selector</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Tweak the compilation kwargs</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>
    <span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rcompile_registry</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>

    <span class="c1"># Recursive profiling not supported -- would be a complete mess</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;profiler&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_lower</span><span class="p">(</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Misc helpers</span>


<span class="n">IRs</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;IRs&#39;</span><span class="p">,</span> <span class="s1">&#39;expressions clusters stree uiet iet&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ArgumentsMap</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allocator</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_allocator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_platform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_language</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_compiler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">_options</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">comm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The MPI communicator the arguments are collective over.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">comm</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_NULL</span>


<span class="k">def</span> <span class="nf">parse_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse keyword arguments provided to an Operator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># `dse` -- deprecated, dropped</span>
    <span class="n">dse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;dse&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The `dse` argument is deprecated. &quot;</span>
                <span class="s2">&quot;The optimization level is now controlled via the `opt` argument&quot;</span><span class="p">)</span>

    <span class="c1"># `dle` -- deprecated, replaced by `opt`</span>
    <span class="k">if</span> <span class="s1">&#39;dle&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The `dle` argument is deprecated. &quot;</span>
                <span class="s2">&quot;The optimization level is now controlled via the `opt` argument&quot;</span><span class="p">)</span>
        <span class="n">dle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Both `dle` and `opt` were passed; ignoring `dle` argument&quot;</span><span class="p">)</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Setting `opt=</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dle</span><span class="p">))</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">dle</span>
    <span class="k">elif</span> <span class="s1">&#39;opt&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">opt</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;opt&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">opt</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mode</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">opt</span><span class="p">,</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mode</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;noop&#39;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">opt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">mode</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="n">opt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span> <span class="n">opt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mode</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">flatten</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">opt</span><span class="p">)),</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InvalidOperator</span><span class="p">(</span><span class="s2">&quot;Illegal `opt=</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">opt</span><span class="p">))</span>

    <span class="c1"># `opt`, deprecated kwargs</span>
    <span class="n">kwopenmp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openmp&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;openmp&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">kwopenmp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">openmp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">,</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;openmp&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">openmp</span> <span class="o">=</span> <span class="n">kwopenmp</span>

    <span class="c1"># `opt`, options</span>
    <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;openmp&#39;</span><span class="p">,</span> <span class="n">openmp</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;mpi&#39;</span><span class="p">,</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;opt-options&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="c1"># Handle deprecations</span>
    <span class="n">deprecated_options</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;cire-mincost-inv&#39;</span><span class="p">,</span> <span class="s1">&#39;cire-mincost-sops&#39;</span><span class="p">,</span> <span class="s1">&#39;cire-maxalias&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">deprecated_options</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring deprecated optimization option `</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span>

    <span class="c1"># `opt`, mode</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;noop&#39;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="c1"># `platform`</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;platform&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument `platform` should be a `str`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">platform</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">_accepted</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InvalidOperator</span><span class="p">(</span><span class="s2">&quot;Illegal `platform=</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">platform</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">platform_registry</span><span class="p">[</span><span class="n">platform</span><span class="p">]()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">]</span>

    <span class="c1"># `language`</span>
    <span class="n">language</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;language&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">language</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument `language` should be a `str`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">language</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">_accepted</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InvalidOperator</span><span class="p">(</span><span class="s2">&quot;Illegal `language=</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">language</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">language</span>
    <span class="k">elif</span> <span class="n">kwopenmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Handle deprecated `openmp` kwarg for backward compatibility</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;openmp&#39;</span> <span class="k">if</span> <span class="n">openmp</span> <span class="k">else</span> <span class="s1">&#39;C&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span>

    <span class="c1"># `compiler`</span>
    <span class="n">compiler</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compiler&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">compiler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument `compiler` should be a `str`&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">compiler</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">_accepted</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InvalidOperator</span><span class="p">(</span><span class="s2">&quot;Illegal `compiler=</span><span class="si">%s</span><span class="s2">`&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">compiler</span><span class="p">))</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compiler_registry</span><span class="p">[</span><span class="n">compiler</span><span class="p">](</span><span class="n">platform</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">],</span>
                                                         <span class="n">language</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">],</span>
                                                         <span class="n">mpi</span><span class="o">=</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">any</span><span class="p">([</span><span class="n">platform</span><span class="p">,</span> <span class="n">language</span><span class="p">]):</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span> <span class="o">=</span>\
            <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__new_with__</span><span class="p">(</span><span class="n">platform</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;platform&#39;</span><span class="p">],</span>
                                                   <span class="n">language</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">],</span>
                                                   <span class="n">mpi</span><span class="o">=</span><span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;mpi&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">configuration</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">__new_with__</span><span class="p">()</span>

    <span class="c1"># `allocator`</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allocator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_allocator</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compiler&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2016-2019, Devito.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>