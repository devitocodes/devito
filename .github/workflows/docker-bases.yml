name: Build base compilers docker images

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    paths:
      - "/docker/Dockerfile.nvidia"
      - "/docker/Dockerfile.cpu"
      - "/docker/Dockerfile.amd"
      - "/docker/Dockerfile.intel"
      - "/docker/Dockerfile.nogil"
  workflow_dispatch:
    inputs:
      nogil:
        type: boolean
        default: true
      cpu:
        type: boolean
        default: true
      nvidia:
        type: boolean
        default: true
      amd:
        type: boolean
        default: true
      intel:
        type: boolean
        default: true

      tags:
        description: "Build compiler bases"
  schedule:
    # Run once a month
    - cron: "0 0 1 * *"

jobs:
  #######################################################
  ########### Free-threaded Python meta-base ############
  #######################################################
  deploy-nogil-base:
    name: "python-nogil-base"
    runs-on: ubuntu-latest
    if: inputs.nogil
    env:
      DOCKER_BUILDKIT: "1"

    steps:
      - name: Checkout devito
        uses: actions/checkout@v5

      - name: Check event name
        run: echo ${{ github.event_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build free-threaded Python base
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.nogil"
          push: true
          tags: "devitocodes/bases:python-nogil"

  #######################################################
  ############## Basic gcc CPU ##########################
  #######################################################
  deploy-cpu-bases:
    if: inputs.cpu
    name: "cpu-base"
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"

    strategy:
      matrix:
        gcc: ["", "14"]
        disable-gil: [false, true]
        include:
          - disable-gil: false
            build-args: ""
            suffix: ""
          - disable-gil: true
            build-args: "base=devitocodes/bases:python-nogil"
            suffix: "-nogil"

    steps:
      - name: Checkout devito
        uses: actions/checkout@v4

      - name: Check event name
        run: echo ${{ github.event_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: GCC image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.cpu"
          push: true
          build-args: |
            gcc=${{ matrix.gcc }}
            ${{ matrix.build-args }}
          tags: "devitocodes/bases:cpu-gcc${{ matrix.gcc }}${{ matrix.suffix }}"

  #######################################################
  ############## Intel OneApi CPU #######################
  #######################################################
  deploy-oneapi-bases:
    if: inputs.intel
    name: "oneapi-base"
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"

    strategy:
      matrix:
        include:
          - disable-gil: false
            build-args: ""
            suffix: ""
          - disable-gil: true
            build-args: "base=devitocodes/bases:python-nogil"
            suffix: "-nogil"

    steps:
      - name: Checkout devito
        uses: actions/checkout@v5

      - name: Check event name
        run: echo ${{ github.event_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ICX image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.intel"
          push: true
          target: "icx"
          build-args: |
            arch=icx
            ${{ matrix.build-args }}
          tags: "devitocodes/bases:cpu-icx${{ matrix.suffix }}"

      - name: SYCL CPU image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.intel"
          push: true
          target: "cpu-sycl"
          build-args: |
            arch=cpu-sycl
            ${{ matrix.build-args }}
          tags: "devitocodes/bases:cpu-sycl${{ matrix.suffix }}"

      - name: SYCL GPU image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.intel"
          push: true
          target: "gpu-sycl"
          build-args: |
            arch=gpu-sycl
            ${{ matrix.build-args }}
          tags: "devitocodes/bases:gpu-sycl${{ matrix.suffix }}"

  #######################################################
  ################### Nvidia nvhpc ######################
  #######################################################
  deploy-nvidia-bases:
    if: inputs.nvidia
    name: "nvidia-bases"
    runs-on: ["self-hosted", "nvidiagpu"]
    env:
      DOCKER_BUILDKIT: "1"

    strategy:
      matrix:
        include:
          - disable-gil: false
            build-args: ""
            suffix: ""
          - disable-gil: true
            build-args: "base=devitocodes/bases:python-nogil"
            suffix: "-nogil"

    steps:
      - name: Checkout devito
        uses: actions/checkout@v5

      - name: Check event name
        run: echo ${{ github.event_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: NVC image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.nvidia"
          push: true
          target: "nvc"
          build-args: |
            arch=nvc
            ${{ matrix.build-args }}
          # Label (not tag) with runner name for traceability without changing image tags
          labels: builder-runner=${{ runner.name }}
          tags: "devitocodes/bases:nvidia-nvc${{ matrix.suffix }}"

      - name: NVCC image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.nvidia"
          push: true
          target: "nvcc"
          build-args: |
            arch=nvcc
            ${{ matrix.build-args }}
          labels: builder-runner=${{ runner.name }}
          tags: "devitocodes/bases:nvidia-nvcc${{ matrix.suffix }}"

      - name: NVC host image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.nvidia"
          push: true
          target: "nvc-host"
          build-args: |
            arch=nvc-host
            ${{ matrix.build-args }}
          labels: builder-runner=${{ runner.name }}
          tags: "devitocodes/bases:cpu-nvc${{ matrix.suffix }}"

  #######################################################
  ##################### AMD #############################
  #######################################################
  deploy-amd-bases:
    if: inputs.amd
    name: "amd-base"
    runs-on: ["self-hosted", "amdgpu"]
    env:
      DOCKER_BUILDKIT: "1"

    strategy:
      matrix:
        include:
          - disable-gil: false
            build-args: ""
            suffix: ""
          - disable-gil: true
            build-args: "base=devitocodes/bases:python-nogil"
            suffix: "-nogil"

    steps:
      - name: Checkout devito
        uses: actions/checkout@v5

      - name: Check event name
        run: echo ${{ github.event_name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: AMD image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.amd"
          push: true
          target: "amdclang"
          build-args: |
            ROCM_VERSION=5.5.1
            UCX_BRANCH=v1.13.1
            OMPI_BRANCH=v4.1.4
            ${{ matrix.build-args }}
          tags: devitocodes/bases:amd${{ matrix.suffix }}

      - name: AMD HIP image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: "./docker/Dockerfile.amd"
          push: true
          target: "hip"
          build-args: |
            ROCM_VERSION=6.3.4
            ${{ matrix.build-args }}
          tags: devitocodes/bases:amd-hip${{ matrix.suffix }}
